@page "/login"
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject WEB.Services.AuthState AuthState
@using System.Net.Http.Json
@using WEB.Services

<PageTitle>Login</PageTitle>

<h3>Login</h3>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}

<div style="max-width:420px;">
    <div class="mb-3">
        <label class="form-label">Email</label>
        <input class="form-control" @bind="email" />
    </div>

    <div class="mb-3">
        <label class="form-label">Passwort</label>
        <input type="password" class="form-control" @bind="password" />
    </div>

    <button class="btn btn-primary" @onclick="DoLogin" disabled="@busy">
        Login
    </button>
</div>

@code {
    private string email = "";
    private string password = "";
    private string? error;
    private bool busy;

    protected override async Task OnInitializedAsync()
    {
        await AuthState.InitializeAsync();
        if (AuthState.IsAuthenticated)
        {
            // already logged in -> redirect
            if (string.Equals(AuthState.UserType, "Principal", StringComparison.OrdinalIgnoreCase))
                Nav.NavigateTo("/principal");
            else
                Nav.NavigateTo("/teacher");
        }
    }

    private async Task DoLogin()
    {
        error = null;
        busy = true;

        try
        {
            var res = await Http.PostAsJsonAsync("auth/login", new
            {
                email,
                password
            });

            if (!res.IsSuccessStatusCode)
            {
                error = await ApiErrorParser.GetFriendlyMessage(res);
                return;
            }

            var data = await res.Content.ReadFromJsonAsync<AuthResponse>();
            if (data is null || string.IsNullOrWhiteSpace(data.JwtToken))
            {
                error = "Ungültige Server-Antwort.";
                return;
            }

            await JS.InvokeVoidAsync("localStorage.setItem", "jwt", data.JwtToken);
            await JS.InvokeVoidAsync("localStorage.setItem", "userType", data.UserType);
            await AuthState.RefreshAsync();

            // Redirect je nach Rolle
            if (string.Equals(data.UserType, "Principal", StringComparison.OrdinalIgnoreCase))
                Nav.NavigateTo("/principal");
            else
                Nav.NavigateTo("/teacher");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            busy = false;
        }
    }

    private class AuthResponse
    {
        public string JwtToken { get; set; } = "";
        public string UserType { get; set; } = "";
    }
}
