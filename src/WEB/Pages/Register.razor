@page "/register"
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@using System.Net.Http.Json
@using WEB.Services

<PageTitle>Registrieren</PageTitle>

<h3>Registrieren</h3>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
@if (!string.IsNullOrWhiteSpace(success))
{
    <div class="alert alert-success">@success</div>
}

<style>
    .jobcat-missing {
        color: #b42318; /* red */
    }

    .jobcat-assigned {
        color: #047857; /* green */
    }
</style>

<div style="max-width:520px;">
    <div class="mb-3">
        <label class="form-label">Email</label>
        <input class="form-control" @bind="email" />
    </div>

    <div class="row">
        <div class="col mb-3">
            <label class="form-label">Vorname</label>
            <input class="form-control" @bind="firstName" />
        </div>
        <div class="col mb-3">
            <label class="form-label">Nachname</label>
            <input class="form-control" @bind="lastName" />
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Passwort</label>
        <input type="password" class="form-control" @bind="password" />
    </div>

    <div class="mb-3">
        <label class="form-label">Berufskategorien</label>
        @if (jobCategories != null)
        {
            <div>
                @foreach (var cat in jobCategories)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="jc-@cat.Id"
                                @onchange="(e) => ToggleJobCategory(cat.Id, ((ChangeEventArgs)e).Value)"
                                checked="@selectedJobCategoryIds.Contains(cat.Id)" />
                        <label class="form-check-label @GetJobCategoryClass(cat.Id)" for="jc-@cat.Id">@cat.Name</label>
                    </div>
                }
            </div>
        }
    </div>

    <div class="mb-3">
        <label class="form-label">Module</label>
        @if (availableCourses == null || availableCourses.Count <0)
        {
            <div>Bitte wähle zuerst deine Berufskategorien aus.</div>
        }
        else
        {
            <div>
                @foreach (var c in availableCourses)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="c-@c.Id"
                               @onchange="(e) => ToggleCourse(c.Id, ((ChangeEventArgs)e).Value)"
                               checked="@selectedCourseIds.Contains(c.Id)" />
                        <label class="form-check-label" for="c-@c.Id">@c.Name (@c.Acronym)</label>
                    </div>
                }
            </div>
        }
    </div>

    <button class="btn btn-primary" @onclick="DoRegister" disabled="@isLoading">
        Registrieren
    </button>
</div>

@code {
    private string email = "";
    private string firstName = "";
    private string lastName = "";
    private string password = "";

    private string? error;
    private string? success;
    private bool isLoading = false;

    private List<JobCategory>? jobCategories;
    private HashSet<int> selectedJobCategoryIds = new();

    private List<Course>? availableCourses;
    private HashSet<int> selectedCourseIds = new();
    private bool coursesLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobCategories();
    }

    private async Task LoadJobCategories()
    {
        try
        {
            jobCategories = await Http.GetFromJsonAsync<List<JobCategory>>("jobcategory");
        }
        catch
        {
            jobCategories = new List<JobCategory>();
        }
    }

    private async Task LoadCoursesForSelectedCategories()
    {
        coursesLoading = true;
        availableCourses = new List<Course>();
        try
        {
            if (selectedJobCategoryIds.Count ==0)
            {
                availableCourses = new List<Course>();
            }
            else
            {
                // Build query string ?jobCategoryIds=1&jobCategoryIds=2
                var qs = string.Join('&', selectedJobCategoryIds.Select(id => $"jobCategoryIds={id}"));
                availableCourses = await Http.GetFromJsonAsync<List<Course>>($"course?{qs}");
            }
        }
        catch
        {
            availableCourses = new List<Course>();
        }
        finally
        {
            coursesLoading = false;
        }

        StateHasChanged();
    }

    private void ToggleJobCategory(int id, object? checkedValue)
    {
        bool isChecked = false;
        if (checkedValue is bool b)
            isChecked = b;
        else if (checkedValue is string s)
            isChecked = s == "on" || s == "true";

        if (isChecked)
            selectedJobCategoryIds.Add(id);
        else
            selectedJobCategoryIds.Remove(id);

        // After selection changes, reload courses
        _ = LoadCoursesForSelectedCategories();
    }

    private void ToggleCourse(int id, object? checkedValue)
    {
        bool isChecked = false;
        if (checkedValue is bool b)
            isChecked = b;
        else if (checkedValue is string s)
            isChecked = s == "on" || s == "true";

        if (isChecked)
            selectedCourseIds.Add(id);
        else
            selectedCourseIds.Remove(id);

        // Refresh UI so job category colors update immediately
        StateHasChanged();
    }

    private string GetJobCategoryClass(int id)
    {
        if (!selectedJobCategoryIds.Contains(id))
            return string.Empty;

        // If courses are loading, don't color yet
        if (coursesLoading)
            return string.Empty;

        // Check if any selected course belongs to this category
        bool hasSelectedForCategory = selectedCourseIds.Any(scId => availableCourses?.Any(c => c.Id == scId && c.JobCategoryId == id) == true);

        return hasSelectedForCategory ? "jobcat-assigned" : "jobcat-missing";
    }

    private async Task DoRegister()
    {
        error = null;
        success = null;
        isLoading = true;

        try
        {
            var jobIds = selectedJobCategoryIds.ToList();
            var courseIds = selectedCourseIds.ToList();

            var res = await Http.PostAsJsonAsync("auth/register", new RegisterRequest
            {
                Email = email,
                FirstName = firstName,
                LastName = lastName,
                Password = password,
                JobCategoryIds = jobIds,
                CourseIds = courseIds
            });

            if (!res.IsSuccessStatusCode)
            {
                error = await ApiErrorParser.GetFriendlyMessage(res);
                return;
            }

            var data = await res.Content.ReadFromJsonAsync<AuthResponse>();
            if (data is null || string.IsNullOrWhiteSpace(data.JwtToken))
            {
                success = "Registriert. Bitte einloggen.";
                Nav.NavigateTo("/login");
                return;
            }

            await JS.InvokeVoidAsync("localStorage.setItem", "jwt", data.JwtToken);
            await JS.InvokeVoidAsync("localStorage.setItem", "userType", data.UserType);

            success = "Registriert & eingeloggt.";
            Nav.NavigateTo("/teacher");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private class RegisterRequest
    {
        public string Email { get; set; } = "";
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string Password { get; set; } = "";
        public List<int> JobCategoryIds { get; set; } = new();
        public List<int> CourseIds { get; set; } = new();
    }

    private class AuthResponse
    {
        public string JwtToken { get; set; } = "";
        public string UserType { get; set; } = "";
    }

    private class JobCategory
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
    }

    private class Course
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Acronym { get; set; } = "";
        public int JobCategoryId { get; set; }
    }
}
