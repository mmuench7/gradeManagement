@page "/teacher"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using WEB.Services

<PageTitle>Lehrperson</PageTitle>

@if (!string.IsNullOrWhiteSpace(error))
{
 <div class="alert alert-danger">@error</div>
}
@if (!string.IsNullOrWhiteSpace(success))
{
 <div class="alert alert-success">@success</div>
}

@if (pendingRequests != null && pendingRequests.Count >0)
{
 <section class="card mb-3">
 <div class="card-head">
 <h4>Ausstehende Anfragen</h4>
 </div>

 <div class="list">
 @foreach (var x in pendingRequests)
 {
 if (x is null) continue;

 <div class="item">
 <div class="item-top">
 <div>
 <div class="title">Anfrage #@x.Id</div>
<div class="sub">Erstellt am <b>@x.CreatedAt.ToString("dd/MM/yyyy HH:mm")</b></div>
 </div>
 <span class="status status-pending">Wartet auf Antwort</span>
 </div>

 <div class="numbers">
 <div class="num-box">
 <div class="num-label">Alt</div>
 <div class="num">@x.OriginalGradeValue</div>
 </div>
 <div class="arrow">→</div>
 <div class="num-box">
 <div class="num-label">Neu</div>
 <div class="num strong">@x.RequestedGradeValue</div>
 </div>
 </div>

 <div class="reason">
 <div class="reason-label">Begründung</div>
 <div class="reason-text">@x.Reason</div>
 </div>
 </div>
 }
 </div>
 </section>
}

<section class="card">
 <div class="card-head">
 <h4>Noten</h4>
 <span class="pill">Klicke „Übernehmen"</span>
 </div>

 @if (grades is null)
 {
 <p><em>Lade...</em></p>
 }
 else if (grades.Count ==0)
 {
 <p>Keine Noten gefunden.</p>
 }
 else
 {
 <table class="table">
 <thead>
 <tr>
 <th>Schüler</th>
 <th>Fach</th>
 <th>Note</th>
 <th>Datum</th>
 <th></th>
 </tr>
 </thead>
 <tbody>
 @foreach (var g in grades)
 {
 <tr class="@(selectedGradeId == g.GradeId ? "selected" : "")">
 <td>@g.StudentName</td>
 <td>@g.CourseName (@g.CourseAcronym)</td>
 <td><span class="note-badge">@g.CurrentValue</span></td>
 <td>@g.ExamDate.ToString("dd/MM/yyy")</td>
 <td>
 <button class="btn btn-sm btn-primary" @onclick="() => Pick(g)">
 Übernehmen
 </button>
 </td>
 </tr>
 }
 </tbody>
 </table>
 }
</section>

<section class="card mt-3">
 <div class="card-head">
 <h4>Neue Änderungsanfrage</h4>
 </div>

 <div class="mb-2">
 <label class="form-label">Ausgewählte Note</label>
 <input class="form-control" value="@SelectedInfo" disabled />
 </div>

 <div class="mb-2">
 <label class="form-label">Neuer Notenwert</label>
 <input class="form-control" @bind="newValueRaw" />
 </div>

 <div class="mb-2">
 <label class="form-label">Begründung</label>
 <textarea class="form-control" rows="3" @bind="reason"></textarea>
 </div>

 <button class="btn btn-primary w-100 mt-2" @onclick="CreateRequest" disabled="@busy">
Anfrage einreichen
 </button>
</section>

@if (reviewedRequests != null)
{
 <section class="card mt-3">
 <div class="card-head">
 <h4>Verlauf</h4>
 </div>

 @if (reviewedRequests.Count ==0)
 {
 <p>Keine bearbeiteten Anfragen.</p>
 }
 else
 {
 <div class="list">
 @foreach (var x in reviewedRequests)
 {
 if (x is null) continue;

 <div class="item">
 <div class="item-top">
 <div>
 <div class="title">Anfrage #@x.Id</div>
<div class="sub">Erstellt am <b>@x.CreatedAt.ToString("dd/MM/yyyy HH:mm")</b></div>
 </div>

 @if (x.Status?.Equals("Approved", StringComparison.OrdinalIgnoreCase) == true)
 {
 <span class="status status-approved">Akzeptiert</span>
 }
 else if (x.Status?.Equals("Rejected", StringComparison.OrdinalIgnoreCase) == true)
 {
 <span class="status status-rejected">Abgelehnt</span>
 }
 else
 {
 <span class="status status-pending">@x.Status</span>
 }
 </div>

 <div class="numbers">
 <div class="num-box">
 <div class="num-label">Alt</div>
 <div class="num">@x.OriginalGradeValue</div>
 </div>
 <div class="arrow">→</div>
 <div class="num-box">
 <div class="num-label">Neu</div>
 <div class="num strong">@x.RequestedGradeValue</div>
 </div>
 </div>

 @if (!string.IsNullOrWhiteSpace(x.PrincipalComment))
 {
 <div class="reason">
 <div class="reason-label">Kommentar des Prorektors</div>
 <div class="reason-text">@x.PrincipalComment</div>
 </div>
 }

 <div class="time">
Bearbeitet am <b>@(x.ReviewedAt?.ToString("dd/MM/yyyy HH:mm"))</b>
 </div>
 </div>
 }
 </div>
 }
 </section>
}

<style>
 .card {
 background: white;
 border:1px solid #eef2f7;
 border-radius:14px;
 padding:16px;
 }

 .card-head {
 display: flex;
 justify-content: space-between;
 align-items: center;
 gap:12px;
 }

 .pill {
 font-size:12px;
 font-weight:700;
 padding:4px10px;
 border-radius:999px;
 background: #f2f4f7;
 color: #344054;
 }

 .list {
 display: flex;
 flex-direction: column;
 gap:12px;
 margin-top:12px;
 }

 .item {
 border:1px solid #eef2f7;
 border-radius:14px;
 padding:14px;
 background: #fcfdff;
 }

 .item-top {
 display: flex;
 justify-content: space-between;
 align-items: flex-start;
 gap:12px;
 }

 .title {
 font-weight:800;
 }

 .sub {
 color: #667085;
 font-size:12px;
 margin-top:2px;
 }

 .status {
 font-size:12px;
 font-weight:800;
 padding:6px10px;
 border-radius:999px;
 letter-spacing:0.3px;
 border:1px solid transparent;
 }

 .status-pending {
 background: #fff7ed;
 color: #9a3412;
 border-color: #fed7aa;
 }

 .status-approved {
 background: #ecfdf3;
 color: #067647;
 border-color: #abefc6;
 }

 .status-rejected {
 background: #fef3f2;
 color: #b42318;
 border-color: #fecdca;
 }

 .numbers {
 display: flex;
 align-items: center;
 gap:10px;
 margin-top:10px;
 }

 .num-box {
 background: white;
 border:1px solid #e7ecf3;
 border-radius:12px;
 padding:10px12px;
 min-width:110px;
 }

 .num-label {
 font-size:11px;
 color: #667085;
 font-weight:700;
 }

 .num {
 font-size:18px;
 font-weight:800;
 color: #101828;
 }

 .strong {
 color: #1d4ed8;
 }

 .arrow {
 font-weight:900;
 color: #98a2b3;
 }

 .reason {
 margin-top:10px;
 }

 .reason-label {
 font-size:11px;
 color: #667085;
 font-weight:800;
 text-transform: uppercase;
 letter-spacing:0.4px;
 }

 .reason-text {
 margin-top:4px;
 font-weight:600;
 color: #344054;
 }

 .actions {
 display: flex;
 gap:10px;
 align-items: center;
 margin-top:12px;
 }

 .actions .form-control {
 flex:1;
 }

 .time {
 margin-top:10px;
 font-size:12px;
 color: #667085;
 }
</style>

@code {
 private string? error;
 private string? success;
 private bool busy;

 private List<GradeRow>? grades;
 private List<GcrItem>? pendingRequests;
 private List<GcrItem>? reviewedRequests;

 private int? selectedGradeId;
 private decimal? selectedCurrentValue;
 private string selectedLabel = "";

 private string newValueRaw = "";
 private string reason = "";

 protected override async Task OnInitializedAsync()
 {
 var token = await GetTokenOrRedirect();
 if (token is null) return;

 await LoadGrades(token);
 await LoadRequests(token);
 }

 private string SelectedInfo
 => selectedGradeId is null
 ? "-"
 : $"{selectedLabel} (aktuell {selectedCurrentValue})";

 private void Pick(GradeRow g)
 {
 selectedGradeId = g.GradeId;
 selectedCurrentValue = g.CurrentValue;
 selectedLabel = $"{g.StudentName} - {g.CourseAcronym}";
 success = null;
 error = null;
 }

 private async Task LoadGrades(string token)
 {
 error = null;
 grades = await SendGet<List<GradeRow>>("grades/mine", token) ?? new();
 }

 private async Task LoadRequests(string token)
 {
 error = null;
 pendingRequests = await SendGet<List<GcrItem>>("gradechangerequest/teacher/pending", token) ?? new();
 reviewedRequests = await SendGet<List<GcrItem>>("gradechangerequest/teacher/reviewed", token) ?? new();
 }

 private async Task CreateRequest()
 {
 var token = await GetTokenOrRedirect();
 if (token is null) return;

 error = null;
 success = null;

 if (selectedGradeId is null)
 {
 error = "Bitte zuerst eine Note auswählen (Übernehmen klicken).";
 return;
 }

 if (!decimal.TryParse(newValueRaw, out var val) || val <1 || val >6)
 {
 error = "Neue Note muss zwischen1 und6 sein.";
 return;
 }

 if (string.IsNullOrWhiteSpace(reason))
 {
 error = "Begründung ist Pflicht.";
 return;
 }

 busy = true;
 try
 {
 await SendPostRaw("gradechangerequest", new
 {
 GradeId = selectedGradeId.Value,
 RequestedGradeValue = val,
 Reason = reason
 }, token);

 success = "Anfrage wurde eingereicht.";
 newValueRaw = "";
 reason = "";

 // reload requests so pending shows up
 await LoadRequests(token);
 }
 catch (Exception ex)
 {
 error = ex.Message;
 }
 finally
 {
 busy = false;
 }
 }

 private async Task<string?> GetTokenOrRedirect()
 {
 var token = await JS.InvokeAsync<string?>("localStorage.getItem", "jwt");
 if (string.IsNullOrWhiteSpace(token))
 {
 Nav.NavigateTo("/login", true);
 return null;
 }
 return token;
 }

 private async Task<T?> SendGet<T>(string relativeUrl, string token)
 {
 using var req = new HttpRequestMessage(HttpMethod.Get, relativeUrl);
 req.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

 using var res = await Http.SendAsync(req);
 if (!res.IsSuccessStatusCode)
 {
 var message = await ApiErrorParser.GetFriendlyMessage(res);
 throw new Exception(message);
 }

 return await res.Content.ReadFromJsonAsync<T>();
 }

 private async Task<string> SendPostRaw(string relativeUrl, object body, string token)
 {
 using var req = new HttpRequestMessage(HttpMethod.Post, relativeUrl);
 req.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
 req.Content = JsonContent.Create(body);

 using var res = await Http.SendAsync(req);
 var text = await res.Content.ReadAsStringAsync();

 if (!res.IsSuccessStatusCode)
 throw new Exception(await ApiErrorParser.GetFriendlyMessage(res));
 return text;
 }

 private class GradeRow
 {
 public int GradeId { get; set; }
 public string StudentName { get; set; } = "";
 public string CourseName { get; set; } = "";
 public string CourseAcronym { get; set; } = "";
 public decimal CurrentValue { get; set; }
 public DateTime ExamDate { get; set; }
 }

 private class GcrItem
 {
 public int Id { get; set; }
 public int GradeId { get; set; }
 public int TeacherId { get; set; }
 public int PrincipalId { get; set; }
 public decimal OriginalGradeValue { get; set; }
 public decimal RequestedGradeValue { get; set; }
 public string Reason { get; set; } = "";
 public string? PrincipalComment { get; set; }
 public string Status { get; set; } = "";
 public DateTime CreatedAt { get; set; }
 public DateTime? ReviewedAt { get; set; }

 // UI-only field (not in API)
 public string? _comment { get; set; }

 // New: teacher name from API (may be self)
 public string? TeacherName { get; set; }
 public string? CourseName { get; set; }
 }
}
